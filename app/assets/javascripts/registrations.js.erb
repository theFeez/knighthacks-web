<% environment.context_class.instance_eval { include Rails.application.routes.url_helpers } %>

(function () {
  if (document.body.className.indexOf('apply') === -1) {
    return
  }

  var form = document.querySelector('form')
  var getSaveStatus = function () { return document.getElementById('save_status') }

  function update (event) {
    markFieldAsDirty(event.target.id)
    showSavingIndicator()
    sendUpdate()
  }
  const debouncedUpdate = _.debounce(update, 500)

  function markFieldAsDirty (fieldName) {
    var container = document.querySelector('.' + fieldName)
    container && container.classList.add('dirty')
  }

  function showSavingIndicator () {
    getSaveStatus().innerText = 'Saving...'
  }

  form.addEventListener('change', function (event) {
    debouncedUpdate.cancel()
    update(event)
  })

  form.addEventListener('keydown', debouncedUpdate)

  function sendUpdate () {
    const formData = new FormData(form)

    const path = window.location.pathname.split('/')
    const section = path[path.length - 1]

    fetch(form.getAttribute('action') + '?section=' + section, {
      method: "PATCH",
      body: formData,
      credentials: 'same-origin',
      headers: new Headers({
        "Accept": "application/javascript"
      })
    })
      .then(function (response) { return response.text() })
      .then(function (content) { eval(content) })
  }
})()
